name: Release

on:
  release:
    types: [published]
  repository_dispatch:
    types: [release-created]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to upload artifacts to (e.g. v1.2.3)'
        required: false

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (glibc)
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-22.04
            artifact_name: dimension-bridge
            asset_name: dimension-bridge-linux-x86_64
            archive_ext: ".tar.gz"

          # Linux x86_64 (musl - static)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            artifact_name: dimension-bridge
            asset_name: dimension-bridge-linux-x86_64-musl
            archive_ext: ".tar.gz"

          # Linux ARM64 (glibc)
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-22.04
            artifact_name: dimension-bridge
            asset_name: dimension-bridge-linux-aarch64
            archive_ext: ".tar.gz"

          # Linux ARM64 (musl - static)
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            artifact_name: dimension-bridge
            asset_name: dimension-bridge-linux-aarch64-musl
            archive_ext: ".tar.gz"

          # macOS ARM64
          - target: aarch64-apple-darwin
            os: macos-14
            artifact_name: dimension-bridge
            asset_name: dimension-bridge-macos-aarch64
            archive_ext: ".zip"

          # macOS x86_64
          - target: x86_64-apple-darwin
            os: macos-13
            artifact_name: dimension-bridge
            asset_name: dimension-bridge-macos-x86_64
            archive_ext: ".zip"

    env:
      BIN_NAME: dimension-bridge

    steps:
      # 1) Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) Install Rust toolchain
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # 3) Cache Cargo build artifacts
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      # 4) Install cross-compilation tools
      - name: Install cross for cross-compilation
        if: runner.os == 'Linux' && matrix.target != 'x86_64-unknown-linux-gnu'
        run: |
          cargo install cross --git https://github.com/cross-rs/cross

      # 5) Build the release binary
      - name: Build release binary (native)
        if: runner.os == 'macOS' || matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo build --release --target ${{ matrix.target }} --locked

      - name: Build release binary (cross-compile)
        if: runner.os == 'Linux' && matrix.target != 'x86_64-unknown-linux-gnu'
        run: cross build --release --target ${{ matrix.target }} --locked

      # 6) Package binaries
      - name: Package Linux binary (tar.gz)
        if: runner.os == 'Linux'
        run: |
          BIN_DIR=target/${{ matrix.target }}/release
          mkdir -p package
          cp "$BIN_DIR/${{ matrix.artifact_name }}" package/
          cp README.md package/
          cp LICENSE package/
          tar -C package -czf ${{ matrix.asset_name }}.tar.gz .

      - name: Package macOS binary (zip)
        if: runner.os == 'macOS'
        run: |
          BIN="target/${{ matrix.target }}/release/${{ matrix.artifact_name }}"
          ASSET="${{ matrix.asset_name }}.zip"
          mkdir -p package
          cp "$BIN" package/
          cp README.md package/
          cp LICENSE package/
          ditto -c -k --sequesterRsrc package "$ASSET"

      # 7) Generate checksum
      - name: Generate checksum
        run: |
          FILE="${{ matrix.asset_name }}${{ matrix.archive_ext }}"
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sha256sum "$FILE" > "$FILE.sha256"
          else
            shasum -a 256 "$FILE" > "$FILE.sha256"
          fi

      # 8) Upload release artifacts and checksum
      - name: Upload release artifacts
        if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name || github.event.inputs.release_tag }}
          files: |
            ${{ matrix.asset_name }}${{ matrix.archive_ext }}
            ${{ matrix.asset_name }}${{ matrix.archive_ext }}.sha256
